---
- name: Configure Networking in Network Namespaces
  hosts: localhost
  become: yes
  tasks:
    - name: Set IP Forwarding
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
      with_items:
        - { name: "net.bridge.bridge-nf-call-iptables", value: "0" }
        - { name: "net.ipv4.ip_forward", value: "1" }
        - { name: "net.ipv6.conf.default.forwarding", value: "1" }
        - { name: "net.ipv6.conf.all.forwarding", value: "1" }

    - name: Load IP Forwarding Configuration
      shell: "sysctl -p /etc/sysctl.d/10-ip-forwarding.conf"
      args:
        chdir: "/etc/sysctl.d/"
      become: yes

    - name: Configure IP Addresses in Network Namespaces
      command:
        cmd: "ip addr add {{ item.addr }} dev {{ item.dev }}"
      with_items:
        - { addr: "10.1.1.21/24", dev: "phost2pbrg" }
        - { addr: "10.1.1.1/24", dev: "prout2pbrg" }
        - { addr: "10.1.4.21/24", dev: "ohost2obrg" }
        - { addr: "10.1.4.1/24", dev: "orout2obrg" }
        - { addr: "10.1.2.21/24", dev: "yhost2ybrg" }
        - { addr: "10.1.2.1/24", dev: "yrout2ybrg" }
        - { addr: "10.1.3.21/24", dev: "whost2wbrg" }
        - { addr: "10.1.3.1/24", dev: "wrout2wbrg" }
      args:
        creates: "/var/run/netns/{{ item.dev }}"
      ignore_errors: yes

    - name: Bring Up Network Interfaces in Network Namespaces
      command:
        cmd: "ip link set dev {{ item.dev }} up"
      with_items:
        - { dev: "phost2pbrg" }
        - { dev: "prout2pbrg" }
        - { dev: "ohost2obrg" }
        - { dev: "orout2obrg" }
        - { dev: "yhost2ybrg" }
        - { dev: "yrout2ybrg" }
        - { dev: "whost2wbrg" }
        - { dev: "wrout2wbrg" }
      args:
        creates: "/var/run/netns/{{ item.dev }}"
      ignore_errors: yes

    - name: Bring Up Loopback Interfaces in Network Namespaces
      command:
        cmd: "ip link set dev lo up"
      with_items:
        - { dev: "phost" }
        - { dev: "prouter" }
        - { dev: "ohost" }
        - { dev: "orouter" }
        - { dev: "yhost" }
        - { dev: "yrouter" }
        - { dev: "whost" }
        - { dev: "wrouter" }
      args:
        creates: "/var/run/netns/{{ item.dev }}"
      ignore_errors: yes
